FROM node:22-alpine

# Install Python, pip, ffmpeg and yt-dlp with curl-cffi (the magic bypass)
RUN apk add --no-cache python3 py3-pip ffmpeg && \
    pip3 install --no-cache-dir -U "yt-dlp[default,curl-cffi]" && \
    yt-dlp --version  # just to confirm

# Install Deno (you already use it for some extractors)
RUN apk add --no-cache curl && \
    curl -fsSL https://deno.land/install.sh | sh
ENV PATH="/root/.deno/bin:${PATH}"

WORKDIR /app

COPY package.json pnpm-lock.yaml ./

RUN corepack enable && corepack prepare pnpm@latest --activate && \
    pnpm install --frozen-lockfile

COPY . .

CMD ["pnpm", "start"]